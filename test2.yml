---
- name: ec2 test
  hosts: localhost
  become: true
  vars:
    aws_access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37363734353335313637366331356533316266633138303862616232356131323634353739656339
          6432653036343664396137616637666639333137373263320a653765373762313162303834643264
          62333165383531323130653663306332393766646137323963333465326432666663666261333061
          3534306266373064660a613537643536343636303262376166643164363966633934346437303830
          63363039366562663165653633653638356636636263316637343233343532353330
    aws_secret_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36623233666135666666326331653235636234313462623164343730656338363065653764383734
          3966373363373938616239656564666135333030613133330a653030396232663063663666393962
          65383336333334333363323762306561316238393662326166303833343831653636343331333362
          3336666666326236340a646137303835663761653162303531636565626665343038626439373061
          35373163366531663638323437636362373466653931393261373265373462333164393462333630
          3932353936373261653731313463626431353035666134346639
    region: us-west-2

  tasks:
    - name: Build a list of instances
      ec2_instance_info:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ region }}"
      register: aws_instances

    - name: Filter instances based on AlwaysUp:NO tag and missing tag
      set_fact:
        instance_ids: |
          {% set filtered_instances = [] %}
          {% for item in aws_instances.instances if item.tags.AlwaysUp == "NO" -%}
            {{ filtered_instances.append(item.instance_id) }}
          {%- endfor %}
          {{ filtered_instances }}
      with_items: "{{ aws_instances.instances }}"

    - name: Log instance_ids
      debug:
        var: instance_ids
